# 🔧 构建失败排查指南

## ❌ 当前问题

从日志来看，构建失败了：
- `Command failed: pythonforandroid.toolchain create`
- `Buildozer failed to execute the last command`

但工作流显示"构建成功"，这是因为错误检查逻辑有问题。

---

## 🔍 常见构建失败原因

### 1. Python 依赖问题

**症状：**
- `ModuleNotFoundError`
- `ImportError`
- `No module named 'xxx'`

**解决方法：**
- 检查 `buildozer.spec` 中的 `requirements`
- 确保所有依赖都列在 requirements 中
- 某些 Python 包可能不支持 Android

### 2. NDK/SDK 版本问题

**症状：**
- `NDK not found`
- `SDK version mismatch`
- `Unsupported NDK version`

**解决方法：**
- 检查 `buildozer.spec` 中的 NDK 版本
- 当前配置：`android.ndk = 25b`
- 可能需要更新到支持的版本

### 3. 内存不足

**症状：**
- `Killed`
- `Out of memory`
- 构建过程中突然中断

**解决方法：**
- GitHub Actions 有内存限制
- 可能需要优化构建过程
- 或使用更大的 runner

### 4. 权限问题

**症状：**
- `Permission denied`
- `Cannot write to directory`

**解决方法：**
- 检查文件权限
- 确保有写入权限

### 5. 网络问题

**症状：**
- `Failed to download`
- `Connection timeout`
- `Unable to fetch`

**解决方法：**
- GitHub Actions 通常网络稳定
- 如果是依赖下载失败，可能需要重试

---

## 🛠️ 排查步骤

### 步骤 1：查看完整构建日志

1. 在 GitHub Actions 中
2. 点击 "Build APK" 步骤
3. 查看完整日志输出
4. 搜索 "error"、"fail"、"exception"

### 步骤 2：检查 buildozer.spec 配置

确认以下配置正确：

```ini
# 主入口文件
source.main = main_kivy.py

# 依赖（注意格式）
requirements = python3,kivy==2.3.1,pillow,pyjnius

# Android 配置
android.api = 33
android.minapi = 21
android.ndk = 25b
```

### 步骤 3：检查项目文件

确认以下文件存在：
- ✅ `main_kivy.py`
- ✅ `buildozer.spec`
- ✅ `src/` 目录
- ✅ `kivy_ui/` 目录

### 步骤 4：查看错误详情

从日志中查找：
- 第一个错误信息
- 堆栈跟踪（Traceback）
- 失败的命令

---

## 🔧 修复建议

### 1. 更新工作流（已修复）

我已经更新了工作流，现在会：
- ✅ 正确捕获构建错误
- ✅ 显示详细的错误日志
- ✅ 上传构建日志到 Artifacts

### 2. 检查 buildozer.spec

当前配置看起来正确，但可能需要：
- 检查 Kivy 版本兼容性
- 确认所有依赖都支持 Android
- 可能需要移除某些不兼容的依赖

### 3. 简化依赖（如果持续失败）

如果构建持续失败，可以尝试：

```ini
# 最小依赖配置
requirements = python3,kivy==2.3.1,pillow
```

然后逐步添加其他依赖。

---

## 📋 下一步操作

### 1. 重新运行工作流

提交更新的工作流文件后，重新运行：
- Actions → Build HabitBloom APK → Run workflow

### 2. 查看详细日志

- 查看 "Build APK" 步骤的完整日志
- 查看上传的 build.log（在 Artifacts 中）

### 3. 根据错误信息修复

根据日志中的具体错误信息：
- 如果是依赖问题 → 更新 requirements
- 如果是 NDK 问题 → 更新 NDK 版本
- 如果是其他问题 → 根据错误信息修复

---

## 🆘 如果仍然失败

### 提供以下信息：

1. **构建日志的最后 100 行**
   - 特别是错误信息部分

2. **buildozer.spec 配置**
   - 确认当前配置

3. **项目结构**
   - 确认所有必需文件都存在

4. **具体错误信息**
   - 第一个错误是什么
   - 错误发生在哪个步骤

---

## 💡 临时解决方案

如果构建持续失败，可以考虑：

1. **使用 PyQt5 版本**
   - 如果 Kivy 版本有问题
   - 使用 Briefcase 打包 PyQt5 版本

2. **本地构建**
   - 在本地环境构建
   - 使用 WSL 或 Docker

3. **简化应用**
   - 暂时移除可能有问题的功能
   - 先确保基本版本能构建成功

---

**已更新工作流，现在会正确显示错误信息。请重新运行并查看详细日志！** 🔍
